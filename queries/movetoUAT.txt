select distinct
R.PROJECT_NAME,
COUNTYES.UNDER30DAYS, 
COUNTYES.UNDER60DAYS, 
COUNTYES.UNDER90DAYS,
COUNTYES.ABOVE90DAYS 
from SpiraTestEntities.R_Requirements as R
 
left join (
  select
  R2.PROJECT_NAME,
  SUM(
	CASE WHEN  R2.CUST_04 IS NOT NULL AND R2.CUST_06 IS NOT NULL 
            THEN CASE WHEN DiffDays(CAST(R2.CUST_06 AS DATETIME) , CAST(R2.CUST_04 AS DATETIME)) < 30 THEN 1 ELSE 0 END 
        ELSE 
        CASE WHEN DiffDays(CAST(R2.CUST_06 AS DATETIME) , CurrentDateTime()) < 30 THEN 1 ELSE 0 END
   END
   ) AS UNDER30DAYS,
  SUM(
        CASE WHEN  R2.CUST_04 IS NOT NULL AND R2.CUST_06 IS NOT NULL 
             THEN CASE WHEN DiffDays(CAST(R2.CUST_06 AS DATETIME) , CAST(R2.CUST_04 AS DATETIME)) > 30
       AND DiffDays(CAST(R2.CUST_06 AS DATETIME) , CAST(R2.CUST_04 AS DATETIME)) < 60
          THEN 1 
          ELSE 0 
      END 
   ELSE 
      CASE
       WHEN DiffDays(CAST(R2.CUST_06 AS DATETIME) , CurrentDateTime()) > 30 
         AND DiffDays(CAST(R2.CUST_06 AS DATETIME) , CurrentDateTime()) < 60
      THEN 1 
       ELSE 0
     END
   END
   ) AS UNDER60DAYS,
  SUM(CASE WHEN R2.CUST_04 IS NOT NULL AND R2.CUST_06 IS NOT NULL 
      THEN 
          CASE 
           WHEN DiffDays(CAST(R2.CUST_06 AS DATETIME) , CAST(R2.CUST_04 AS DATETIME)) > 61
                 AND DiffDays(CAST(R2.CUST_06 AS DATETIME) , CAST(R2.CUST_04 AS DATETIME)) < 90
          THEN 1 
          ELSE 0 
      END 
   ELSE 
      CASE
       WHEN DiffDays(CAST(R2.CUST_06 AS DATETIME) , CurrentDateTime()) > 61
         AND DiffDays(CAST(R2.CUST_06 AS DATETIME) , CurrentDateTime()) < 90
      THEN 1 
       ELSE 0
     END
   END
   ) AS UNDER90DAYS,
  SUM(CASE WHEN  R2.CUST_04 IS NOT NULL AND R2.CUST_06 IS NOT NULL 
      THEN CASE WHEN DiffDays(CAST(R2.CUST_06 AS DATETIME) , CAST(R2.CUST_04 AS DATETIME)) > 91 THEN 1 ELSE 0 END 
      ELSE CASE WHEN DiffDays(CAST(R2.CUST_06 AS DATETIME) , CurrentDateTime()) > 91 THEN 1 ELSE 0 END
   END
   ) AS ABOVE90DAYS
   from SpiraTestEntities.R_Requirements as R2
    where R2.IS_DELETED = False 
    GROUP BY R2.PROJECT_NAME
) AS COUNTYES ON R.PROJECT_NAME = COUNTYES.PROJECT_NAME
 
where R.IS_DELETED = False